// もちろん、V2対応済み。
class MimiPlayer {
    constructor(fps = 24) {
        this.fps = fps;
        this.instance = null;
        this.version = "1.0";
        this.metadata = { title: '', tempo: 120 };
    }

    _parseHeader(text) {
        const header = { version: "1.0", title: "", tempo: 120 };
        const lines = text.split('\n');
        for (let line of lines) {
            if (!line.startsWith('#')) break;
            
            const vMatch = line.match(/Mimi Music Format v([\d.]+)/);
            if (vMatch) header.version = vMatch[1];

            const tMatch = line.match(/Title:\s*(.*)/);
            if (tMatch) header.title = tMatch[1].trim();

            const tempoMatch = line.match(/Tempo:\s*(\d+)/);
            if (tempoMatch) header.tempo = parseInt(tempoMatch[1], 10);
        }
        return header;
    }

    _instantiatePlayer(version) {
        if (version.startsWith("2")) {
            if (typeof MimiPlayerV2 !== 'undefined') {
                return new MimiPlayerV2(this.fps);
            } else {
                console.error("MimiPlayerV2 (mimi.v2.min.js) is not loaded.");
                return null;
            }
        } else { // Default to V1
            if (typeof MimiPlayerV1 !== 'undefined') {
                return new MimiPlayerV1(this.fps);
            } else {
                console.error("MimiPlayerV1 (mimi.v1.min.js) is not loaded.");
                return null;
            }
        }
    }

    async load(text) {
        const info = this._parseHeader(text);
        if (this.version !== info.version || !this.instance) {
            this.instance = this._instantiatePlayer(info.version);
        }
        
        if (this.instance) {
            this.version = info.version;
            this.metadata = info;
            return this.instance.load(text);
        }
    }

    play(startFrame = 0) {
        if (this.instance) this.instance.play(startFrame);
    }

    stop() {
        if (this.instance) this.instance.stop();
    }

    get activeNodes() {
        return this.instance ? this.instance.activeNodes : new Set();
    }
}