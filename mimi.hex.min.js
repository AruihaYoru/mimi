class MimiHex {
    constructor(audioCtx, sampleRate = 8000) {
        this.ctx = audioCtx;
        this.sampleRate = sampleRate;
        this.activeNodes = new Set();
        this.output = this.ctx.createGain();
        // this.output.connect(this.ctx.destination);
    }

    /**
     * @param {string} hex - 16進数文字列 ("0123456789ABCDEF...")
     * @param {number} startTime - 再生開始時間 (AudioContext.currentTime)
     */
    play(hex, startTime = this.ctx.currentTime) {
        const data = hex.replace(/[^0-9a-fA-F]/g, '');
        if (!data) return null;

        const buffer = this.ctx.createBuffer(1, data.length, this.sampleRate);
        const channelData = buffer.getChannelData(0);
        
        for (let i = 0; i < data.length; i++) {
            channelData[i] = (parseInt(data[i], 16) / 7.5) - 1.0;
        }

        const source = this.ctx.createBufferSource();
        source.buffer = buffer;
        source.connect(this.output);
        
        source.start(startTime);
        
        this.activeNodes.add(source);
        source.onended = () => {
            this.activeNodes.delete(source);
            source.disconnect();
        };

        return source;
    }

    stop() {
        this.activeNodes.forEach(node => {
            try { node.stop(); } catch(e) {}
            node.disconnect();
        });
        this.activeNodes.clear();
    }
}